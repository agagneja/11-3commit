var mongoose = require('mongoose');
var request = require('request');
var user = require('config/models');

exports.login = function(email,password,reg_id,account,callback) {

var newuser = new user({ 
	email:email,
	password:password,
	reg_id: reg_id,
	account:account});

user.find({email:email},function(err,users){

var len = users.length;

if(len == 0){
 	newuser.save(function (err) {
	
	callback({'response':"Sucessfully Registered"});
		
});
}else{

	callback({'response':"User already Registered"});

}});
}
exports.getuser = function(email,callback) {

user.find(function(err,users){

var len = users.length;

if(len == 0){
 	
	
	callback({'response':"No Users Registered"});
		

}else{
callback(removeUser(users, email));
	
}});
}


exports.removeuser = function(email,callback) {

user.remove({email:email},function(err,users){

	if(!err){

		callback({'response':"Removed Sucessfully"});
	}else{
		callback({'response':"Error"});
	}
});
}



exports.send = function(fromn,name,message,gift_id,callback) {
console.log(name);
user.find({email: name},function(err,users){
var len = users.length;
user.find(function(err,users){
	console.log("hey");
	console.log(users[0].email);
	
}
);
if(len == 0){
callback({'response':"Failure"});
}else{
	var to_id = users[0].reg_id;
	var name = users[0].email;
	
request(
    { method: 'POST', 
    uri: 'https://android.googleapis.com/gcm/send',
    headers: {
        'Content-Type': 'application/json',
        'Authorization':'key=AIzaSyAowfJhZ0C7nQbI-nAt-0JHwWZDDySGC6k'
    },
    body: JSON.stringify({
  "registration_ids" : [to_id],
  "data" : {
    "msg":message,
	"name":name,
	"gift_id":gift_id,
	"fromn":fromn
  },
  "time_to_live": 108
})

    }
  , function (error, response, body) {

	  callback({'response':"Success"});
	  console.log(response);
	  
    }
  )
}});

}

function removeUser(arr, val) {
    for(var i=0; i<arr.length; i++) {
        if(arr[i].email == val) {
            arr.splice(i, 1);
            return arr;
            break;
        }
    }
}

